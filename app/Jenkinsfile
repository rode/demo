pipeline {
    agent {
        kubernetes {
            yamlFile "app/jenkins-agent.yaml"
        }
    } 
    stages {
        stage('build') {
            steps {
                container('git') {
                    script {
                        tag = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    }
                }
                container('kaniko') {
                    sh "executor -c app --skip-tls-verify --digest-file image -d harbor.localhost/rode-demo/rode-demo-node-app:${tag}"
                }
                container('git') {
                    sh "cat image"
                    // sh """curl --request POST \
                    // --url http://rode-collector-build.rode-demo.svc.cluster.local:8083/v1alpha1/builds \
                    // --header 'Content-Type: application/json' \
                    // --data '{
	                //     "repository": "https://github.com/rode/demo",
                    //     "artifacts": [
                    //         "harbor.localhost/rode-demo/rode-demo-node-app@sha256:8d4fa54b121be39290055ab79d95543ebcd4b13526026801dfb0697ff3b40700"
                    //     ],
                    //     "commit_id": "'$(git rev-parse HEAD)'"
                    // }'"""
                }
            }
        }
    }
}
